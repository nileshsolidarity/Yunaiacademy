generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  INSTRUCTOR
  STUDENT
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum LessonType {
  VIDEO
  TEXT
  QUIZ
}

model User {
  id             String    @id @default(cuid())
  name           String
  email          String    @unique
  password       String?
  role           UserRole  @default(STUDENT)
  avatar         String?
  bio            String?
  emailVerified  Boolean   @default(false)
  googleId       String?   @unique
  refreshToken   String?
  resetToken     String?
  resetTokenExp  DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  courses        Course[]         @relation("InstructorCourses")
  enrollments    Enrollment[]
  lessonProgress LessonProgress[]
  quizAttempts   QuizAttempt[]
  reviews        Review[]
  certificates   Certificate[]
  posts          Post[]
  comments       Comment[]
  notifications  Notification[]
  aiChatHistory  AiChatHistory[]

  @@map("users")
}

model Course {
  id           String       @id @default(cuid())
  title        String
  slug         String       @unique
  description  String
  thumbnail    String?
  category     String
  level        CourseLevel  @default(BEGINNER)
  status       CourseStatus @default(DRAFT)
  instructorId String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  instructor   User          @relation("InstructorCourses", fields: [instructorId], references: [id])
  modules      Module[]
  enrollments  Enrollment[]
  reviews      Review[]
  certificates Certificate[]
  posts        Post[]

  @@index([instructorId])
  @@index([status])
  @@index([category])
  @@map("courses")
}

model Module {
  id       String @id @default(cuid())
  title    String
  order    Int    @default(0)
  courseId String

  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@index([courseId])
  @@map("modules")
}

model Lesson {
  id       String     @id @default(cuid())
  title    String
  type     LessonType @default(VIDEO)
  videoUrl String?
  content  String?
  duration Int?
  order    Int        @default(0)
  moduleId String

  module         Module           @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  lessonProgress LessonProgress[]
  quiz           Quiz?

  @@index([moduleId])
  @@map("lessons")
}

model Enrollment {
  id          String    @id @default(cuid())
  userId      String
  courseId     String
  progress    Float     @default(0)
  enrolledAt  DateTime  @default(now())
  completedAt DateTime?

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@map("enrollments")
}

model LessonProgress {
  id          String    @id @default(cuid())
  userId      String
  lessonId    String
  completed   Boolean   @default(false)
  completedAt DateTime?

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@map("lesson_progress")
}

model Quiz {
  id           String @id @default(cuid())
  title        String
  lessonId     String @unique
  passingScore Int    @default(70)
  timeLimit    Int?

  lesson    Lesson         @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions QuizQuestion[]
  attempts  QuizAttempt[]

  @@map("quizzes")
}

model QuizQuestion {
  id            String  @id @default(cuid())
  quizId        String
  question      String
  options       Json
  correctAnswer Int
  explanation   String?
  order         Int     @default(0)

  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@map("quiz_questions")
}

model QuizAttempt {
  id          String   @id @default(cuid())
  userId      String
  quizId      String
  score       Float
  answers     Json
  submittedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([quizId])
  @@map("quiz_attempts")
}

model Review {
  id        String   @id @default(cuid())
  userId    String
  courseId   String
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId])
  @@map("reviews")
}

model Certificate {
  id                String   @id @default(cuid())
  userId            String
  courseId           String
  certificateNumber String   @unique
  issuedAt          DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([certificateNumber])
  @@map("certificates")
}

model Post {
  id        String   @id @default(cuid())
  title     String
  content   String
  userId    String
  courseId   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  course   Course?   @relation(fields: [courseId], references: [id], onDelete: SetNull)
  comments Comment[]

  @@index([userId])
  @@index([courseId])
  @@map("posts")
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  userId    String
  postId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@map("comments")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  read      Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notifications")
}

model AiChatHistory {
  id        String   @id @default(cuid())
  userId    String
  role      String
  message   String
  sessionId String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, sessionId])
  @@map("ai_chat_history")
}
